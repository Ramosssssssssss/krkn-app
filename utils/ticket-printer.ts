import { TicketViewProps } from "@/components/pos/TicketView";
import { COMPANY_INFO } from "@/constants/company";

const ESC = "\x1B";
const GS = "\x1D";

const CMD = {
    INIT: ESC + "@",
    CENTER: ESC + "a" + "\x01",
    LEFT: ESC + "a" + "\x00",
    DOUBLE_H: ESC + "!" + "\x10",
    NORMAL: ESC + "!" + "\x00",
    LF: "\n",
    FEED: (n: number) => ESC + "d" + String.fromCharCode(n),
    PARTIAL_CUT: GS + "V" + "\x01",
};

const W = 32;

const fmt = (n: number) => "$" + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

const pad = (left: string, right: string, width = W) => {
    const spaces = width - left.length - right.length;
    return left + " ".repeat(Math.max(spaces, 1)) + right;
};

const center = (text: string, width = W) => {
    const spaces = width - text.length;
    const leftPad = Math.floor(spaces / 2);
    return " ".repeat(Math.max(leftPad, 0)) + text;
};

const line = (char = "-", width = W) => char.repeat(width);

const truncate = (str: string, max: number) =>
    str.length > max ? str.substring(0, max - 1) + "." : str;

export function generateTicketESCPOS(data: TicketViewProps): string {
    const now = new Date();
    const fecha = data.fecha || now.toLocaleDateString("es-MX");
    const hora = data.hora || now.toLocaleTimeString("es-MX");

    const subtotal = data.total / 1.16;
    const iva = data.total - subtotal;

    let t = "";
    // --- HEADER ---
    t += CMD.INIT + CMD.CENTER + CMD.DOUBLE_H + COMPANY_INFO.nombre + CMD.LF + CMD.NORMAL;
    t += center(COMPANY_INFO.direccion) + CMD.LF;
    t += center(`${COMPANY_INFO.rfc} | ${COMPANY_INFO.telefono}`) + CMD.LF;
    t += CMD.LF + line("=") + CMD.LF;

    // --- INFO VENTA ---
    t += CMD.LEFT;
    t += pad("Folio:", data.folio || "V-0001") + CMD.LF;
    t += pad("Fecha:", `${fecha} ${hora}`) + CMD.LF;
    if (data.cajero) t += pad("Cajero:", data.cajero) + CMD.LF;
    if (data.caja) t += pad("Caja:", data.caja) + CMD.LF;
    t += line("-") + CMD.LF;

    // --- CLIENTE ---
    t += pad("Cliente:", truncate(data.cliente, W - 9)) + CMD.LF;
    if (data.clienteRFC) t += pad("RFC Cli:", data.clienteRFC) + CMD.LF;
    t += line("-") + CMD.LF + CMD.LF;

    // --- ARTÃCULOS ---
    for (const item of data.items) {
        const lineTotal = item.precio * item.cantidad;
        t += truncate(item.descripcion, W) + CMD.LF;
        t += pad(`  ${item.cantidad} x ${fmt(item.precio)}`, fmt(lineTotal)) + CMD.LF;
    }

    t += CMD.LF + line("-") + CMD.LF;

    // --- TOTALES ---
    t += pad("Subtotal", fmt(subtotal)) + CMD.LF;
    t += pad("IVA (16%)", fmt(iva)) + CMD.LF + CMD.LF;
    t += CMD.DOUBLE_H + pad("TOTAL", fmt(data.total)) + CMD.LF + CMD.NORMAL;
    t += line("-") + CMD.LF;

    // --- PAGO ---
    t += pad("Metodo Pago:", data.metodoPago.toUpperCase()) + CMD.LF;
    if (data.recibido) t += pad("Recibido:", fmt(data.recibido)) + CMD.LF;
    if (data.cambio) t += pad("Cambio:", fmt(data.cambio)) + CMD.LF;
    t += line("=") + CMD.LF + CMD.LF;

    if (data.notas) {
        t += "NOTAS:" + CMD.LF + data.notas + CMD.LF + CMD.LF;
    }

    // --- FOOTER ---
    t += CMD.CENTER + "Gracias por su preferencia" + CMD.LF;
    t += COMPANY_INFO.website + CMD.LF;
    t += CMD.LF + center(COMPANY_INFO.lema) + CMD.LF;
    t += CMD.LF + CMD.LF + CMD.FEED(5) + CMD.PARTIAL_CUT;
    return t;
}

const logoRawHex = "000000000000000000000000000001FFF80000000000000000000000000000000000000000000000000000003FFFFF800000000000000000000000000000000000000000000000000001FFF0FFF80000000000000000000000000000000000000000000000000007F80001FE000000000000000000000000000000000000000000000000003F8000001F800000000000000000000000000000000000000000000000007C00000007E0000000000000000000000000000000000000000000000001F000000000F8000000000000000000000000000000000000000000000007C0000000003C00000000000000000000000000000000000000000000000F80000000001F00000000000000000000000000000000000000000000001E00000000000780000000000000000000000000000000000000000000007C0000000000000000000000000000000000000000000000000000000000F0000000FFFFFFFFF0000000000000000000000000000000000000000001E000001FFFFFFFFFF0000000000000000000000000000000000000000003C000007FFFFFFFFFF0000000000000000000000000000000000000000007800001FFFFFFFFFFF000000000000000000000000000000000000000000F000007FFFFFFFFFFE000000000000000000000000000000000000000000E00000FFFFFFFFFFFE000000000000000000000000000000000000000001C00001FFFFFFFFFFFC000000000000000000000000000000000000000003800003FFFFFFFFFFFC000000000000000000000000000000000000000003800007FFFFFFFFFFF800000000000000000000000000000000000000000700000FFFFFFFFFFFF200000000000000000000000000000000000000000E00001FFFFFFFFFFFE700000000000000000000000000000000000000000E00003FFFFFFFFFFF87000000000000000000000000000000000000000001C00007FFFFF8000000380000000000000000000000000000000000000001C00007FFFF800000003800000000000000000000000000000000000000000380000FFFFE000000001C000000000000000000000000000000000000000380000FFFF8000000001C000000000000000000000000000000000000000700001FFFF0000000000C000000000000000000000000000000000000000700001FFFE0000000000E000000000000000000000000000000000000080600001FFFC00000000006000000000000000000000000000000000000040E00003FFF800000000007000000000000000000000000000000000000070E00003FFF000000000007000000000000000000000000000000000000038C00003FFF00000000000300000000000000000000000000000000000001E400003FFE00000000000300000000000000000000000000000000000001F000007FFE00000000000380000000000000000000000000000000000000FC00007FFC000000000003800000000000000000000000000000000000007F00007FFC000000000003800000000000000000000000000000000000003FC0007FFC000000000001800000000000000000000000000000000000001FF0007FFC000000000001800000000000000000000000000000000000000FFC007FF80000000000018000000000000000000000000000000000000007FF807FF80000000000018000000000000000000000000000000000000033FFF83FF8001E000000018000000000000000000000000000000000000039FFFF800001FF00000001C000000000000000000000000000000000000038FFFFFFE7FFFF0000000180000000000000000000000000000000000000387FFFFFFFFFFF00000001C0000000000000000000000000000000000000383FFFFFFFFFFF0000000180000000000000000000000000000000000000380FFFFFFFFFFF00000001800000000000000000000000000000000000003803FFFFFFFFFF00000001800000000000000000000000000000000000001801FFFFFFFFFF000000018000000000000000000000000000000000000018007FFFFFFFFF000000018000000000000000000000000000000000000018001FFFFFFFFF00000003800000000000000000000000000000000000001C0003FFFFFFFE00000003800000000000000000000000000000000000001C0000FFFFFFFE00000003800000000000000000000000000000000000001C00007FFFFFE000000003000000000000000000000000000000000000000C00007FFFFC0000000003000000000000000000000000000000000000000E00007FF8000000000007000000000000000000000000000000000000000E00007FF8000000000007000000000000000000000000000000000000000600007FF8000000000006000000000000000000000000000000000000000700007FF800000000000E000000000000000000000000000000000000000700007FF800000000000E000000000000000000000000000000000000000300007FF800000000001C000000000000000000000000000000000000000380007FF800000000001C000000000000000000000000000000000000000180007FF8000000000038000000000000000000000000000000000000000180007FF80000000000380000000000000000000000000000000000000000E0007FF80000000000700000000000000000000000000000000000000000E0007FF8000000000070000000000000000000000000000000000000000070007FF80000000000E0000000000000000000000000000000000000000070007FF80000000001C0000000000000000000000000000000000000000038007FF80000000001C000000000000000000000000000000000000000001C007FF800000000038000000000000000000000000000000000000000001E007FF800000000070000000000000000000000000000000000000000000F007FF8000000000E00000000000000000000000000000000000000000007807FF8000000001E00000000000000000000000000000000000000000003C07FF8000000003C00000000000000000000000000000000000000000001E07FF0000000007800000000000000000000000000000000000000000000F07FF000000000F000000000000000000000000000000000000000000000787FE000000001E0000000000000000000000000000000000000000000003E7FE00000000780000000000000000000000000000000000000000000000F7FC00000000F0000000000000000000000000000000000000000000000077F000000003E0000000000000000000000000000000000000000000000017E00000000F80000000000000000000000000000000000000000000000003000000003F0000000000000000000000000000000000000000000000000038000001FC00000000000000000000000000000000000000000000000000FF00000FF0000000000000000000000000000000000000000000000000001FF803FF800000000000000000000000000000000000000000000000000003FFFFFC0000000000000000000000000000000000000000000000000000003FFFC0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001F80FE008180FC003F8000000000000000000000000000000000000000003000C3008180820060C0000000000000000000000000000000000000000004000C10081808100C06000000000000000000000000000000000000000000C000C100818081008020000000000000000000000000000000000000000008000C100818083008030000000000000000000000000000000000000000008780C2008180C6008010000000000000000000000000000000000000000008080FC008180FC008030000000000000000000000000000000000000000004080D8008180C0008020000000000000000000000000000000000000000006080C800810080004060000000000000000000000000000000000000000003180C6004300800030C00003FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF801F80C3003E0080001F0";

export function generateTicketZPL(data: TicketViewProps): string {
    const now = new Date();
    const fecha = data.fecha || now.toLocaleDateString("es-MX");
    const hora = data.hora || now.toLocaleTimeString("es-MX");
    const W = 42;

    // Header section
    const headerLines = [
        COMPANY_INFO.nombre,
        COMPANY_INFO.direccion.substring(0, W),
        `${COMPANY_INFO.rfc}  ${COMPANY_INFO.telefono}`
    ];
    const headerBody = headerLines.join("\\&");

    // Items and data
    const itemsParts: string[] = [
        `REF: ${data.folio || "V-0001"}`,
        `FECHA: ${fecha} ${hora}`
    ];

    if (data.cajero) itemsParts.push(`ATENDIDO POR: ${data.cajero}`);
    if (data.caja) itemsParts.push(`CAJA: ${data.caja}`);

    itemsParts.push("------------------------------------------");
    itemsParts.push(`CLIENTE: ${data.cliente.substring(0, 30)}`);
    if (data.clienteRFC) itemsParts.push(`RFC CLI: ${data.clienteRFC}`);
    itemsParts.push("------------------------------------------");

    data.items.forEach((it) => {
        const lineTotal = it.precio * it.cantidad;
        const totalStr = "$" + lineTotal.toFixed(2);
        itemsParts.push(it.descripcion.substring(0, W));
        itemsParts.push(`  ${it.cantidad} x $${it.precio.toFixed(2)}      ${totalStr}`);
        itemsParts.push("");
    });

    itemsParts.push("------------------------------------------");
    itemsParts.push(`SUBTOTAL              $${(data.total / 1.16).toFixed(2)}`);
    itemsParts.push(`IVA (16.0%)           $${(data.total - data.total / 1.16).toFixed(2)}`);
    itemsParts.push(`TOTAL                 $${data.total.toFixed(2)}`);
    itemsParts.push("------------------------------------------");
    itemsParts.push(`METODO PAGO: ${data.metodoPago.toUpperCase()}`);
    if (data.cambio) itemsParts.push(`SU CAMBIO: $${data.cambio.toFixed(2)}`);

    const itemsBody = itemsParts.join("\\&");
    const footerBody = "Gracias por su preferencia\\&" + COMPANY_INFO.website;

    const top = 40;
    const headerH = headerLines.length * 30;
    const itemsH = itemsParts.length * 28;
    const totalH = top + 170 + headerH + itemsH + 250; // Increased height to prevent cutoff

    let z = `^XA^CI28^PW600^LL${totalH}`;
    z += `^FO184,${top}^GFA,5070,5070,30,${logoRawHex}^FS`;
    z += `^FO0,${top + 180}^A0N,28,28^FB600,${headerLines.length},0,C,0^FD${headerBody}^FS`;
    z += `^FO40,${top + 180 + headerH + 20}^A0N,24,24^FB520,${itemsParts.length},0,L,0^FD${itemsBody}^FS`;
    z += `^FO0,${top + 180 + headerH + itemsH + 60}^A0N,24,24^FB600,2,0,C,0^FD${footerBody}^FS^XZ`;
    return z;
}
